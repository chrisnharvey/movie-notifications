<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Notify extends Cron
{
	public function __construct()
	{
		parent::__construct();
	}
	
	public function theaters()
	{
		$this->db->select('notify.*')
				 ->select('movies.*')
				 ->select('releases.*')
				 ->select('(SELECT value FROM users_meta WHERE users_meta.key=\'notify_start\' AND user_id=notify.user_id) AS notify_start', FALSE)
				 ->select('(SELECT value FROM users_meta WHERE users_meta.key=\'notify_end\' AND user_id=notify.user_id) AS notify_end', FALSE);
				 
		$this->db->join('movies', 'notify.movie_id = movies.id')
				 ->join('releases', 'movies.id = releases.movie_id', 'inner');
		
		$this->db->where('notify.id NOT IN (SELECT notify_id FROM notifications)', NULL, FALSE)
				 ->where('releases.date BETWEEN CURDATE() AND DATE(DATE_ADD(CURDATE(), INTERVAL 7 DAY))', NULL, FALSE)
				 ->where('DATEDIFF(releases.date, NOW()) <= (SELECT value FROM users_meta WHERE users_meta.key=\'days_to_notify\' AND user_id=notify.user_id)', NULL, FALSE)
				 ->where('(SELECT value FROM users_meta WHERE users_meta.key=\'notify_start\' AND user_id=notify.user_id) > HOUR(NOW())')
				 ->where('(SELECT value FROM users_meta WHERE users_meta.key=\'notify_end\' AND user_id=notify.user_id) < HOUR(NOW())');
		
		$this->db->order_by('((SELECT value FROM users_meta WHERE users_meta.key=\'notify_end\' AND user_id=notify.user_id) - (SELECT value FROM users_meta WHERE users_meta.key=\'notify_start\' AND user_id=notify.user_id))', 'asc', FALSE);
		$notifs = $this->db->get('notify');
		
		echo $this->db->last_query();
		
		$to_notify = array();
		
		foreach($notifs->result() as $notif)
		{
			if($this->user_m->meta('days_to_notify', $notif->user_id) >= $this->_days(NULL, strtotime($notif->date)))
			{
				$start = $this->user_m->meta('notify_start', $notif->user_id);
				$end = $this->user_m->meta('notify_end', $notif->user_id);
				
				if($start <= date('G') AND $end - $start == 1)
				{
					
				}
			}
		}
	}
	
	private function _days($start = NULL, $end)
	{
		if($start == NULL)
		{
			$start = time();
		}
		
		$diff = $end - $start;
		
		return round($diff / 86400);
	}
	
	public function dvd()
	{
		
	}
}
